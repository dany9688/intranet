{% extends 'planilla/base.html' %}
{% load static %}
{% block title %}Guardia{% endblock title %}
{% block css_block %}
<!-- Bootstrap 5 -->

{% endblock %}
{% block content %}
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
        <div class="col-sm-6">
            <!-- <h2 class="p-2">Panel de guardia</h2> -->
            <span id="destacamento" hidden>{{destacamento}}</span>
        </div>
        </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
        <div class="container-fluid">
          <!-- Contenedor de Toasts de Bootstrap -->
          <div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
            <div id="toastContainer" class="toast-container"></div>
          </div>
        <!-- 1ra fila -->

      <div class="row">
        <div class="col-md-3">
          {% if request.user.groups.all.0.name == "Guardia central"  %}
          <button type="button" data-toggle="modal" data-target="#cambiarcuartel"  class="btn btn-xs btn-secondary mb-2 col-md-12">Cambiar estado de cuartel</button>
          {% endif %}
          {%for cuartel in base %}
          <div class="row">
          <div class="col-md-12">
              <!-- Widget: user widget style 2 -->
              <div class="card card-outline {% if cuartel.estado == 'Cubriendo zona' %} card-success {% elif cuartel.estado == 'En apoyo' %} card-warning {% elif cuartel.estado == 'Sin chofer' %} card-danger {%endif%}">
                <!-- Add the bg color to the header using any of the bg-* classes -->
                 <!-- {% if cuartel.estado == "Cubriendo zona" %}
                <div class="widget-user-header bg-success">
                 {% elif cuartel.estado == "En apoyo" %}
                 <div class="widget-user-header bg-warning">
                 {% elif cuartel.estado == "Sin chofer" %} 
                 <div class="widget-user-header bg-danger">
                {%endif%} -->
                  <!-- <div class="widget-user-image">
                    <img class="img-circle elevation-2 d-inline" src="{% static 'planilla/logo.png' %}" alt="User Avatar">
                  </div> -->
                  <!-- /.widget-user-image -->
                   <div class="card-header">
                    <h5 class="d-inline">{{cuartel.base|upper}} - </h5>
                    <strong><span class="d-inline">{{cuartel.estado|upper}}</span></strong>
                   </div>
                <div class="card-footer p-0">
                  <ul class="nav flex-column">
                    <li class="nav-item">
                      <span style="cursor: default;" class="nav-link">
                        {% for cuenta in cuentas %}
                        {% if cuenta.base == cuartel.base%}
                        Móviles disponibles <span class="float-right badge bg-success" style="font-size: 16px;">{{cuenta.en_servicio}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles ocupados <span class="float-right badge bg-secondary" style="font-size: 16px;">{{cuenta.ocupados}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles en condicional <span class="float-right badge bg-warning" style="font-size: 16px;">{{cuenta.condicional}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles fuera de servicio <span class="float-right badge bg-danger" style="font-size: 16px;">{{cuenta.fuera_servicio}}</span>
                      </span>
                    </li>
                    {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
              <!-- /.widget-user -->
            </div>
          </div>
            {%endfor%}
          </div>
          <div class="col-md-4">
          <div class="col-md-12">
            <div class="card card-navy card-outline overflow-auto" style="width: 100%;">
              <div class="card-header d-flex">
                <h3 class="card-title">Servicios activos</h3>
                {% if request.user.groups.all.0.name == "Guardia central"  %}
                <a class="btn btn-sm btn-danger ml-auto" href="/cargar_servicio"><i class="fa-regular fa-bell"></i> Nuevo servicio</a>
                {% endif %}
              </div>
              <!-- /.card-header -->
              <div class="card-body" style="height: 690px;">
                {% if servicios %}
                <!-- we are adding the accordion ID so Bootstrap's collapse plugin detects it -->
                <div id="accordion">
                  {% for servicio in servicios %}
                    {% if servicio.estado == "En curso" %}
                      {% if "Incendio" in servicio.tipo.tipo %}
                      <div class="card card-danger mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% elif "Auxilio" in servicio.tipo.tipo %}
                      <div class="card card-teal mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% elif "Colaboración" in servicio.tipo.tipo %}
                      <div class="card card-gray mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% elif "Accidente" in servicio.tipo.tipo %}
                      <div class="card card-warning mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% else %}
                      <div class="card card-navy mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% endif %}
                    <div class="card-header d-flex">
                      <h4 class="card-title w-100">
                        <a class="d-block w-100 float-left" style="cursor: pointer;" data-toggle="collapse" data-target="#collapse{{ servicio.id }}" aria-expanded="false">
                          Servicio {{ servicio.numero }} - {{ servicio.tipo.tipo }}
                        </a>
                      </h4>
                      <span class="badge bg-warning float-right contador-servicio" id="contador{{servicio.numero}}" data-inicio="{{ servicio.salida|date:'c' }}"></span>
                    </div>
                    <div id="collapse{{ servicio.id }}" class="collapse">
                      <div class="card-body">
                        <div class="ml-2">
                          <div class="mb-2">
                            <strong>TIPO DE SERVICIO:</strong>
                            <span>{{ servicio.tipo.tipo }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>HORARIO DE SALIDA:</strong>
                            <span>{{ servicio.salida }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>DIRECCIÓN:</strong>
                            <span>{{ servicio.direccion }}</span>
                          </div> 
                          <div class="mb-2">
                            <strong>ZONA:</strong>
                            <span>{{ servicio.zona }}</span>
                          </div> 
                        <div class="mt-3">
                          <a href="/servicio_detail/{{servicio.id}}" class="btn bg-secondary float-right mr-1">
                            <i class="fas fa-magnifying-glass-location"></i>Ver
                          </a>
                        </div>         
                      </div>
                    </div>
                  </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                  </div>
                {% else %}
                <p>No hay servicios cargados.</p>
              {% endif %}
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            </div>
            <!-- /.card -->
        <div class="col-md-5">
          <!-- <div class="row col-md-12">
            <button class="btn btn-sm btn-secondary mr-2" id="hidrantes">Mostrar/Ocultar Hidrantes</button>
            <button class="btn btn-sm btn-secondary" id="cuarteles">Mostrar/Ocultar Cuarteles</button>
          </div> -->
          <div class="card card-primary card-outline">
            <div class="card-header">
              <h3 class="card-title">Mapa</h3>
            </div>
            <div class="card-body p-0">

                <div id="map" style="height: 700px; width: 100%;"></div>
                <button id="hidrantes" style="
                    position: absolute;
                    top: 112px;
                    left: 12px;
                    z-index: 1000;
                    background: #ffffff;
                    color: black;
                    border: none;
                    padding: 10px;
                    cursor: pointer;
                    font-weight:bold;
                  ">
                    <i class="fa-brands fa-hire-a-helper"></i> Hidrantes
                </button>
                <button id="cuarteles" style="
                    position: absolute;
                    top: 160px;
                    left: 12px;
                    z-index: 1000;
                    background: #ffffff;
                    color: black;
                    border: none;
                    padding: 10px;
                    cursor: pointer;
                    font-weight: bold;
                  ">
                    <i class="fa-solid fa-warehouse"></i> Cuarteles
                </button>
            </div>
          </div>
        </div>

        <!-- MODAL CAMBIAR CUARTEL -->
          <div class="modal fade" id="cambiarcuartel" tabindex="-1" aria-labelledby="cambiarcuartel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel3">Cambiar estado de cuartel</h5>
                </div>
                <div class="modal-body">
                    <form action="/cambiaestbase/" method="POST">
                      {% csrf_token %}
                      <label for="movil">Indique el cuartel:</label>
                      <select class="form-control col-sm-6" name="base">
                        {% for cuartel in base %}
                        <option value={{cuartel.id}}>{{cuartel.base}}</option>
                        {%endfor%}
                      </select>
                      <label for="movil">Indique el nuevo estado:</label>
                      <select class="form-control col-sm-6" name="estado">
                        <option value="Cubriendo zona">Cubriendo zona</option>
                        <option value="En apoyo">En apoyo</option>
                        <option value="Sin chofer">Sin chofer</option>
                      </select>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Cambiar estado</button>
                </form>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          
                </div>
              </div>
            </div>
        </div>
        <!-- MODAL CAMBIAR CUARTEL -->
                    <!-- Modal de Notificación -->
              <div class="modal fade" id="alertaModal" tabindex="-1" aria-labelledby="alertaModalLabel" aria-hidden="true">
              <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                  <h5 class="modal-title" id="alertaModalLabel">🚨 Alerta de Servicio</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                  <p id="mensajeNotificacion">¡Nueva alerta!</p>
                  <audio id="sonidoAlarma">
                    <source src="{% static 'planilla/audio/alarma.mp3'%}" type="audio/mp3">
                  </audio>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-danger" id="cerrarModal">Cerrar</button>
                </div>
              </div>
              </div>
              </div>
        </div>
    </div>
    
  </div>
{% endblock %}
{% block js_block %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgZ9iDyLaJEwAAYUcuN7MgVWN2alaLd1s&libraries=places"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
<script>
    const ZONAS_JSON_URL = "{% static 'planilla/zonas.json' %}";
    const HIDRANTES_JSON_URL = "{% static 'planilla/hidrantes.json' %}";
    const HIDRANTES_PNG_URL = "{% static 'planilla/images/hidrante.png' %}"
    const CUARTELES_JSON_URL = "{% static 'planilla/cuarteles.json' %}"
    const PNG_URL = "{% static 'planilla/' %}"

</script>
<script src="{% static 'planilla/mapa.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      function actualizarContadores() {
          document.querySelectorAll(".contador-servicio").forEach(function(elemento) {
              let inicioStr = elemento.getAttribute("data-inicio");
              if (!inicioStr) return; // Si no tiene data-inicio, salir
  
              let inicio = new Date(inicioStr);
              let ahora = new Date();
              let diferencia = Math.floor((ahora - inicio) / 1000); // Diferencia en segundos
  
              let horas = Math.floor(diferencia / 3600);
              let minutos = Math.floor((diferencia % 3600) / 60);
              let segundos = diferencia % 60;
  
              // Formateo con ceros a la izquierda
              minutos = minutos.toString().padStart(2, '0');
              segundos = segundos.toString().padStart(2, '0');
  
              elemento.textContent = `${horas}h ${minutos}m ${segundos}s`;
          });
      }
  
      actualizarContadores(); // Actualizar al cargar
      setInterval(actualizarContadores, 1000); // Actualizar cada segundo
  });
  </script>

<script>
  // Inicializa el modal manualmente
  const alertaModal = new bootstrap.Modal(document.getElementById("alertaModal"));

  // Función para cerrar el modal
  document.getElementById("cerrarModal").addEventListener("click", function() {
      alertaModal.hide();
  });
  
  const destacamento = "{{ destacamento|default:'' }}".trim();  // Asegura que la variable se pase correctamente

  if (destacamento) {
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    let destacamentoNormalizado = normalizarDestacamento({destacamento});

    let socket = new WebSocket(`${protocol}://${window.location.host}/ws/notificaciones/${destacamentoNormalizado}/`);
    console.log(socket)
      socket.onopen = () => console.log(`✅ Conectado al WebSocket de ${destacamento}`);
      socket.onerror = (error) => console.error("❌ Error en WebSocket:", error);
      socket.onmessage = (event) => console.log("📩 Mensaje recibido:", event.data);



  socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log("📩 Notificación recibida:", data.mensaje);

    // Actualizar el mensaje en el modal
    document.getElementById("mensajeNotificacion").textContent = data.mensaje;

    // Reproducir sonido de alarma
    const audio = document.getElementById("sonidoAlarma");
    audio.play().catch(error => console.error("Error al reproducir el sonido:", error));

    // Mostrar el modal de Bootstrap
    const alertaModal = new bootstrap.Modal(document.getElementById("alertaModal"));
    alertaModal.show();
  };

  socket.onclose = function(event) {
      console.log("WebSocket cerrado.");
  };

} else {
      console.error("❌ No se pudo conectar al WebSocket: el destacamento está vacío.");
  }
  function normalizarDestacamento(nombre) {
    // Si nombre es un objeto, extraer la propiedad 'destacamento'
    if (typeof nombre === "object" && nombre !== null && "destacamento" in nombre) {
        nombre = nombre.destacamento;  // Obtener el valor real
    }

    // Validar que ahora sea un string antes de aplicar toLowerCase()
    if (typeof nombre !== "string") {
        console.error("Error: el valor no es un string", nombre);
        return "";
    }

    return nombre.toLowerCase()
                 .replace("°", "")
                 .replace(/\s+/g, "_")
                 .replace(/[^a-z0-9_]/g, "");
}
</script>
<script>
  const socket = new WebSocket("wss://" + window.location.host + "/ws/servicios/");

  socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      
      if (data.tipo === "nuevo_servicio") {
          const servicio = data.servicio;
          alert("Nuevo servicio: " + servicio.numero + " - " + servicio.tipo);

          // Aquí puedes actualizar la lista de servicios dinámicamente
          // Ejemplo: agregar nuevo servicio a la lista sin recargar la página
          const serviciosContainer = document.getElementById("accordion");
          const nuevoServicio = `
              <div class="card card-danger mb-2">
                  <div class="card-header d-flex">
                      <h4 class="card-title w-100">
                          <a class="d-block w-100 float-left" data-toggle="collapse" data-target="#collapse${servicio.id}">
                              Servicio ${servicio.numero} - ${servicio.tipo}
                          </a>
                      </h4>
                  </div>
                  <div id="collapse${servicio.id}" class="collapse">
                      <div class="card-body">
                          <strong>DIRECCIÓN:</strong> ${servicio.direccion} <br>
                          <strong>ZONA:</strong> ${servicio.zona}
                      </div>
                  </div>
              </div>`;
          
          serviciosContainer.innerHTML += nuevoServicio;
      }
  };
</script>


{% endblock %}
