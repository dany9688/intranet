{% extends 'planilla/base.html' %}
{% load static %}
{% block title %}Guardia{% endblock title %}
{% block css_block %}
<!-- Bootstrap 5 -->
<link rel="stylesheet" href="{% static 'planilla/bootstrap-duallistbox.min.css' %}">
{% endblock %}
{% block content %}
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
        <div class="col-sm-6">

        </div><!-- /.col -->
        </div>
        <!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
        <div class="container-fluid">
          <!-- Contenedor de Toasts de Bootstrap -->
          <div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
            <div id="toastContainer" class="toast-container"></div>
          </div>
        <!-- 1ra fila -->
        <div class="row mb-2 ml-1 mr-2 d-flex">
            <h2 class="p-2">Panel de guardia</h2>
            {% if request.user.groups.all.0.name == "Guardia central"  %}
            <button type="button" data-toggle="modal" data-target="#cambiarcuartel"  class="btn btn-xs btn-secondary ml-auto">Cambiar estado<br>de cuartel</button>
            {% endif %}
        </div>

        <div class="modal fade" id="cambiarcuartel" tabindex="-1" aria-labelledby="cambiarcuartel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel3">Cambiar estado de cuartel</h5>
              </div>
              <div class="modal-body">
                  <form action="/cambiaestbase/" method="POST">
                    {% csrf_token %}
                    <label for="movil">Indique el cuartel:</label>
                    <select class="form-control col-sm-6" name="base">
                      {% for cuartel in base %}
                      <option value={{cuartel.id}}>{{cuartel.base}}</option>
                      {%endfor%}
                    </select>
                    <label for="movil">Indique el nuevo estado:</label>
                    <select class="form-control col-sm-6" name="estado">
                      <option value="Cubriendo zona">Cubriendo zona</option>
                      <option value="En apoyo">En apoyo</option>
                      <option value="Sin chofer">Sin chofer</option>
                    </select>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Cambiar estado</button>
              </form>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        
              </div>
            </div>
          </div>
      </div>
      <div class="row">
        <div class="col-md-3">
          {%for cuartel in base %}
          <div class="row">
            <div class="col-md-12">
              <!-- Widget: user widget style 2 -->
              <div class="card card-widget widget-user-2">
                <!-- Add the bg color to the header using any of the bg-* classes -->
                 {% if cuartel.estado == "Cubriendo zona" %}
                <div class="widget-user-header bg-success">
                 {% elif cuartel.estado == "En apoyo" %}
                 <div class="widget-user-header bg-warning">
                 {% elif cuartel.estado == "Sin chofer" %} 
                 <div class="widget-user-header bg-danger">
                {%endif%}
                  <!-- <div class="widget-user-image">
                    <img class="img-circle elevation-2 d-inline" src="{% static 'planilla/logo.png' %}" alt="User Avatar">
                  </div> -->
                  <!-- /.widget-user-image -->
                  <h4 class="d-inline">{{cuartel.base|upper}} - </h4>
                  <span class=" d-inline">{{cuartel.estado|upper}}</span>
                </div>
                <div class="card-footer p-0">
                  <ul class="nav flex-column">
                    <li class="nav-item">
                      <span style="cursor: default;" class="nav-link">
                        {% for cuenta in cuentas %}
                        {% if cuenta.base == cuartel.base%}
                        Móviles disponibles <span class="float-right badge bg-success" style="font-size: 16px;">{{cuenta.en_servicio}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles ocupados <span class="float-right badge bg-secondary" style="font-size: 16px;">{{cuenta.ocupados}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles en condicional <span class="float-right badge bg-warning" style="font-size: 16px;">{{cuenta.condicional}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles fuera de servicio <span class="float-right badge bg-danger" style="font-size: 16px;">{{cuenta.fuera_servicio}}</span>
                      </span>
                    </li>
                    {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
              <!-- /.widget-user -->
            </div>
          </div>
            {%endfor%}
          </div>
          <div class="col-md-4">
            <div class="row col-md-12">
            <div class="card card-navy" style="width: 100%;">
              <div class="card-header d-flex">
                <h3 class="card-title">Servicios activos</h3>
                {% if request.user.groups.all.0.name == "Guardia central"  %}
                <a class="btn btn-danger ml-auto p-2" href="/cargar_servicio"><i class="fa-regular fa-bell"></i> Nuevo servicio</a>
                {% endif %}
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                {% if servicios %}
                <!-- we are adding the accordion ID so Bootstrap's collapse plugin detects it -->
                <div id="accordion">
                  {% for servicio in servicios %}
                    {% if servicio.estado == "En curso" %}
                    {% if "Incendio" in servicio.tipo.tipo %}
                    <div class="card card-danger">
                    {% elif "Auxilio" in servicio.tipo.tipo %}
                    <div class="card card-teal">
                    {% elif "Colaboración" in servicio.tipo.tipo %}
                    <div class="card card-gray">
                    {% elif "Accidente" in servicio.tipo.tipo %}
                    <div class="card card-warning">
                    {% else %}
                    <div class="card card-navy">
                    {% endif %}
                    <div class="card-header">
                      <h4 class="card-title w-100">
                        <a class="d-block w-100" style="cursor: default;" data-toggle="collapse" href="#collapse{{ servicio.numero }}">
                          Servicio {{ servicio.numero }} - {{ servicio.tipo.tipo }}
                        </a>
                      </h4>
                    </div>
                    <div id="collapse{{ servicio.numero }}" class="collapse" data-parent="#accordion">
                      <div class="card-body">
                        <div class="ml-2">
                          <div class="mb-2">
                            <strong>TIPO DE SERVICIO:</strong>
                            <span>{{ servicio.tipo.tipo }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>HORARIO DE SALIDA:</strong>
                            <span>{{ servicio.salida }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>DIRECCIÓN:</strong>
                            <span>{{ servicio.direccion }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>UNIDADES ASIGNADAS:</strong><br>
                            <div id="listaMovilesAsignados">
                                {% for movil_data in servicio.moviles_list %}
                                <button type="button" class="btn btn-secondary mt-2 mr-2">Móvil {{ movil_data.movil.numero }}</button>
                                {% endfor %}
                            </div>
                        </div>    
                        <div class="mt-3">
                          <a href="/modificar_servicio/{{servicio.id}}" class="btn bg-warning float-left"><i class="fa-solid fa-pen-to-square"></i></a>
                          <button class="btn btn-success ml-2" data-toggle="modal" data-target="#modalAsignarMovil"><i class="fa-solid fa-plus"></i> <i class="fa-solid fa-truck-front"></i></button>

                          <div class="modal fade" id="modalAsignarMovil" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-xl" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Asignar Móvil y Bomberos</h5>
                                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                                    </div>
                                    <div class="modal-body">
                                      <form action="/asignarmovil/{{servicio.id}}/" method="post">
                                        {% csrf_token %}
                                        <label for="movilSelect">Móvil:</label>
                                        <select id="movilSelect" class="form-control col-md-3" name="movil">
                                            {% for movil in moviles %}
                                            <option value="{{movil.id}}">Móvil {{movil.numero}}</option>
                                            {%endfor%}
                                        </select>

                                        <label for="bomberosSelect">Bomberos:</label>
                                        {% if bomberos1 %}  
                                        <select id="bomberosSelect" class="form-control duallistbox" multiple style="height: 300px;" name="bomberos">
                                          {% for bombero in bomberos1 %}
                                            <option value="{{bombero.id}}">{{bombero.IDJerarquia.jerarquia}} - {{bombero.apellido|upper}}, {{bombero.nombre}}</option>
                                            {%endfor%}
                                        </select>
                                        {%else%}
                                        <span>NO HAY BOMBEROS</span>
                                        {%endif%}
                                      </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-success" data-servicio-id="{{ servicio.id }}" id="asignarMovil">Asignar</button>
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                    </div>
                                  </form>
                                </div>
                            </div>
                        </div>

                          {% if request.user.groups.all.0.name == "Guardia central"  %}
                          <a href="/finalizar_servicio/{{servicio.id}}" class="btn bg-danger float-right">Finalizar</a>
                          {% endif %}
                        </div>         
                      </div>
                    </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                {% else %}
                <p>No hay servicios cargados.</p>
              {% endif %}
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
        </div>

        </div>
    </div>
        </div>

{% endblock %}
{% block js_block %}
<!-- 
<script>
  $(document).ready(function() {
      $('[data-toggle="popover"]').popover({
          trigger: 'hover', // Cambia a 'hover' si lo prefieres
          html: true
      });
  });
</script> -->

<script>
  $(document).ready(function() {
      $(".asignarMovilBtn").click(function() {
          var servicioId = $(this).data("servicio-id");  // Obtiene el ID desde el atributo "data-servicio-id"
          $("#asignarMovil").data("servicio-id", servicioId);  // Lo guarda en el botón de asignación
      });

      $("#asignarMovil").click(function(event) {
          event.preventDefault();  // Evita la recarga de la página

          var servicioId = $(this).data("servicio-id");  // Obtiene el servicio ID almacenado
          var movilId = $("#movilSelect").val();
          var bomberosSeleccionados = $("#bomberosSelect").val(); // Obtiene los IDs de bomberos

          $.ajax({
              url: "/asignarmovil/" + servicioId + "/",  
              type: "POST",
              data: {
                  movil: movilId,
                  bomberos: bomberosSeleccionados,
                  csrfmiddlewaretoken: "{{ csrf_token }}"
              },
              dataType: "json",
              success: function(response) {
                  if (response.success) {
                      var bomberosList = "<ul>";
                      response.bomberos.forEach(function(bombero) {
                          bomberosList += "<li>" + bombero.apellido.toUpperCase() + ", " + bombero.nombre + "</li>";
                      });
                      bomberosList += "</ul>";

                      var nuevoBoton = `
                          <button type="button" class="btn btn-secondary mt-2 mr-2" 
                                  data-toggle="popover" data-html="true" 
                                  title="Bomberos Asignados" 
                                  data-content='${bomberosList}'>
                              Móvil ${response.movil_numero}
                          </button>`;

                      $("#listaMovilesAsignados").append(nuevoBoton);

                      $("#modalAsignarMovil").modal("hide");
                  } else {
                      alert("Error al asignar el móvil.");
                  }
              },
              error: function() {
                  alert("Hubo un error en la petición AJAX.");
              }
          });
      });
  });
</script>



  
 
<script src="{% static 'planilla/jquery.bootstrap-duallistbox.js' %}"></script>
<script>
  $(function () {
  //Bootstrap Duallistbox
  $('.duallistbox').bootstrapDualListbox()
  })
</script>

<script>
document.getElementById("asignarMovil").addEventListener("click", function() {
    let movil = document.getElementById("movilSelect");
    let bomberos = document.getElementById("bomberosSelect");
    let seleccionados = Array.from(bomberos.selectedOptions).map(option => option.text).join(", ");
    
    let div = document.createElement("div");
    div.innerHTML = `<strong>${movil.options[movil.selectedIndex].text}:</strong> ${seleccionados}`;
    document.getElementById("movilesAsignados").appendChild(div);
    
        // Limpiar selección de bomberos
        bomberos.selectedIndex = -1;
    
    // Cerrar el modal correctamente
    $('#modalAsignarMovil').modal('hide');
});
</script>
{% endblock %}