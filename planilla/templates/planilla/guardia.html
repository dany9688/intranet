{% extends 'planilla/base.html' %}
{% load static %}
{% block title %}Guardia{% endblock title %}
{% block css_block %}
<!-- Bootstrap 5 -->

{% endblock %}
{% block content %}
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
        <div class="col-sm-6">
            <h2 class="p-2">Panel de guardia</h2>
            <span id="destacamento" hidden>{{destacamento}}</span>
        </div><!-- /.col -->
        </div>
        <!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
        <div class="container-fluid">
          <!-- Contenedor de Toasts de Bootstrap -->
          <div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
            <div id="toastContainer" class="toast-container"></div>
          </div>
        <!-- 1ra fila -->

      <div class="row">
        <div class="col-md-3">
          {% if request.user.groups.all.0.name == "Guardia central"  %}
          <button type="button" data-toggle="modal" data-target="#cambiarcuartel"  class="btn btn-xs btn-secondary mb-2 col-md-12">Cambiar estado de cuartel</button>
          {% endif %}
          {%for cuartel in base %}
          <div class="row">
          <div class="col-md-12">
              <!-- Widget: user widget style 2 -->
              <div class="card card-widget widget-user-2">
                <!-- Add the bg color to the header using any of the bg-* classes -->
                 {% if cuartel.estado == "Cubriendo zona" %}
                <div class="widget-user-header bg-success">
                 {% elif cuartel.estado == "En apoyo" %}
                 <div class="widget-user-header bg-warning">
                 {% elif cuartel.estado == "Sin chofer" %} 
                 <div class="widget-user-header bg-danger">
                {%endif%}
                  <!-- <div class="widget-user-image">
                    <img class="img-circle elevation-2 d-inline" src="{% static 'planilla/logo.png' %}" alt="User Avatar">
                  </div> -->
                  <!-- /.widget-user-image -->
                  <h4 class="d-inline">{{cuartel.base|upper}} - </h4>
                  <span class=" d-inline">{{cuartel.estado|upper}}</span>
                </div>
                <div class="card-footer p-0">
                  <ul class="nav flex-column">
                    <li class="nav-item">
                      <span style="cursor: default;" class="nav-link">
                        {% for cuenta in cuentas %}
                        {% if cuenta.base == cuartel.base%}
                        Móviles disponibles <span class="float-right badge bg-success" style="font-size: 16px;">{{cuenta.en_servicio}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles ocupados <span class="float-right badge bg-secondary" style="font-size: 16px;">{{cuenta.ocupados}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles en condicional <span class="float-right badge bg-warning" style="font-size: 16px;">{{cuenta.condicional}}</span>
                      </span>
                    </li>
                    <li class="nav-item">
                      <span style="cursor: default;"  class="nav-link">
                        Móviles fuera de servicio <span class="float-right badge bg-danger" style="font-size: 16px;">{{cuenta.fuera_servicio}}</span>
                      </span>
                    </li>
                    {% endif %}
                    {% endfor %}
                  </ul>
                </div>
              </div>
              <!-- /.widget-user -->
            </div>
          </div>
            {%endfor%}
          </div>
          <div class="col-md-4">
          <div class="row col-md-12">
            <div class="card card-navy" style="width: 100%;">
              <div class="card-header d-flex">
                <h3 class="card-title">Servicios activos</h3>
                {% if request.user.groups.all.0.name == "Guardia central"  %}
                <a class="btn btn-sm btn-danger ml-auto p-2" href="/cargar_servicio"><i class="fa-regular fa-bell"></i> Nuevo servicio</a>
                {% endif %}
              </div>
              <!-- /.card-header -->
              <div class="card-body" style="height: 690px;">
                {% if servicios %}
                <!-- we are adding the accordion ID so Bootstrap's collapse plugin detects it -->
                <div id="accordion">
                  {% for servicio in servicios %}
                    {% if servicio.estado == "En curso" %}
                      {% if "Incendio" in servicio.tipo.tipo %}
                      <div class="card card-danger mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% elif "Auxilio" in servicio.tipo.tipo %}
                      <div class="card card-teal mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% elif "Colaboración" in servicio.tipo.tipo %}
                      <div class="card card-gray mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% elif "Accidente" in servicio.tipo.tipo %}
                      <div class="card card-warning mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% else %}
                      <div class="card card-navy mb-2" id="grupo-servicio-{{ servicio.id }}">
                      {% endif %}
                    <div class="card-header d-flex">
                      <h4 class="card-title w-100">
                        <a class="d-block w-100 float-left" style="cursor: pointer;" data-toggle="collapse" data-target="#collapse{{ servicio.id }}" aria-expanded="false">
                          Servicio {{ servicio.numero }} - {{ servicio.tipo.tipo }}
                        </a>
                      </h4>
                      <span class="badge bg-warning float-right" id="contador" data-inicio="{{ servicio.salida|date:'c' }}"></span>
                    </div>
                    <div id="collapse{{ servicio.id }}" class="collapse">
                      <div class="card-body">
                        <div class="ml-2">
                          <div class="mb-2">
                            <strong>TIPO DE SERVICIO:</strong>
                            <span>{{ servicio.tipo.tipo }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>HORARIO DE SALIDA:</strong>
                            <span>{{ servicio.salida }}</span>
                          </div>
                          <div class="mb-2">
                            <strong>DIRECCIÓN:</strong>
                            <span>{{ servicio.direccion }}</span>
                          </div> 
                        <div class="mt-3">
                          {% if request.user.groups.all.0.name == "Guardia central"  %}
                          <a href="/finalizar_servicio/{{servicio.id}}" class="btn btn-app bg-danger float-right">
                            <i class="fas fa-rectangle-xmark"></i> Finalizar
                          </a>
                          {% endif %}
                          <a href="/servicio_detail/{{servicio.id}}" class="btn btn-app bg-secondary float-right mr-1">
                            <i class="fas fa-magnifying-glass-location"></i>Ver
                          </a>
                        </div>         
                      </div>
                    </div>
                  </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                  </div>
                {% else %}
                <p>No hay servicios cargados.</p>
              {% endif %}
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            </div>
            <!-- /.card -->
        <div class="col-md-5">
          <div class="row col-md-12">
            <button class="btn btn-sm btn-secondary mr-2" id="hidrantes">Mostrar/Ocultar Hidrantes</button>
            <button class="btn btn-sm btn-secondary" id="cuarteles">Mostrar/Ocultar Cuarteles</button>
          </div>
          <div class="row col-sm-12 mt-3" style="border-style: solid; border-color: black;">
            <div id="map" style="height: 700px; width: 100%;"></div>
          </div>
        </div>

        <!-- MODAL CAMBIAR CUARTEL -->
          <div class="modal fade" id="cambiarcuartel" tabindex="-1" aria-labelledby="cambiarcuartel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel3">Cambiar estado de cuartel</h5>
                </div>
                <div class="modal-body">
                    <form action="/cambiaestbase/" method="POST">
                      {% csrf_token %}
                      <label for="movil">Indique el cuartel:</label>
                      <select class="form-control col-sm-6" name="base">
                        {% for cuartel in base %}
                        <option value={{cuartel.id}}>{{cuartel.base}}</option>
                        {%endfor%}
                      </select>
                      <label for="movil">Indique el nuevo estado:</label>
                      <select class="form-control col-sm-6" name="estado">
                        <option value="Cubriendo zona">Cubriendo zona</option>
                        <option value="En apoyo">En apoyo</option>
                        <option value="Sin chofer">Sin chofer</option>
                      </select>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">Cambiar estado</button>
                </form>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          
                </div>
              </div>
            </div>
        </div>
        <!-- MODAL CAMBIAR CUARTEL -->
        </div>
    </div>
    
  </div>
{% endblock %}
{% block js_block %}
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgZ9iDyLaJEwAAYUcuN7MgVWN2alaLd1s&libraries=places"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier/1.0.3/oms.min.js"></script>
<script>
    const ZONAS_JSON_URL = "{% static 'planilla/zonas.json' %}";
    const HIDRANTES_JSON_URL = "{% static 'planilla/hidrantes.json' %}";
    const HIDRANTES_PNG_URL = "{% static 'planilla/images/hidrante.png' %}"
    const CUARTELES_JSON_URL = "{% static 'planilla/cuarteles.json' %}"
    const PNG_URL = "{% static 'planilla/' %}"

</script>
<script src="{% static 'planilla/mapa.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      function actualizarContador() {
          let inicioStr = document.getElementById("contador").getAttribute("data-inicio");
          let inicio = new Date(inicioStr); // Convertir a objeto Date
          let ahora = new Date();
          let diferencia = Math.floor((ahora - inicio) / 1000); // Diferencia en segundos
  
          let horas = Math.floor(diferencia / 3600);
          let minutos = Math.floor((diferencia % 3600) / 60);
          let segundos = diferencia % 60;
  
          document.getElementById("contador").textContent = 
              `${horas}h ${minutos}m ${segundos}s`;
      }
  
      actualizarContador(); // Actualizar al cargar
      setInterval(actualizarContador, 1000); // Actualizar cada segundo
  });
</script>

<script>
  let destacamento = document.getElementById('destacamento').innerText
  console.log(destacamento)
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  let destacamentoNormalizado = normalizarDestacamento({destacamento});

  let socket = new WebSocket(`${protocol}://${window.location.host}/ws/notificaciones/${destacamentoNormalizado}/`);
// const socket = new WebSocket("ws://127.0.0.1:8001/ws/notificaciones/destacamento_2/");


  socket.onopen = () => console.log("Conectado");
  socket.onerror = (error) => console.log("Error:", error);
  socket.onmessage = (event) => console.log("Mensaje recibido:", event.data);

  socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      alert(`🔔 Notificación: ${data.mensaje}`);
  };

  socket.onclose = function(event) {
      console.log("WebSocket cerrado.");
  };

  function normalizarDestacamento(nombre) {
    // Si nombre es un objeto, extraer la propiedad 'destacamento'
    if (typeof nombre === "object" && nombre !== null && "destacamento" in nombre) {
        nombre = nombre.destacamento;  // Obtener el valor real
    }

    // Validar que ahora sea un string antes de aplicar toLowerCase()
    if (typeof nombre !== "string") {
        console.error("Error: el valor no es un string", nombre);
        return "";
    }

    return nombre.toLowerCase()
                 .replace("°", "")
                 .replace(/\s+/g, "_")
                 .replace(/[^a-z0-9_]/g, "");
}
</script>

{% endblock %}