<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Intranet - Movil</title>
        <link rel="icon" href="{% static 'planilla/logo.png' %}" type="image/png" />       
        <!-- Google Font: Source Sans Pro -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/css/adminlte.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css">
    </head>

  <body>

    <div class="wrapper">
<style>
  #map {
      height: 500px;
      width: 100%;
  }
</style>
    <!-- Content Wrapper. Contains page content -->
    <div class="">
    <!-- Content Header (Page header) -->
    <div class="content-header bg-danger">
        <div class="container-fluid">
        <div class="col-sm-12 text-center">
          <h3><strong>PANEL DE COMANDO - MÓVIL {{movil.numero}}</strong></h3>
        </div><!-- /.col -->
        </div>
        <!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
        <div class="container-fluid">
          {% if servicio %}
          <span id="movil">{{movil.id}}</span>
        <!-- 1ra fila -->
         <div class="row">
          <div class="col-md-6 mt-2" style="max-height: 500px;">
            <div class="card card-danger">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-bullhorn"></i>
                  Intervención en curso
                </h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <div class="callout callout-danger">
                  <h5>Tipo de servicio</h5>
                  <p>{{ servicio.tipo.tipo }}</p>
                </div>
                <div class="callout callout-info">
                  <h5>Dirección</h5>
                  <p>{{servicio.direccion}}</p>
                </div>
                <div class="callout callout-warning">
                  <h5>Número de servicio</h5>
                  <p>{{servicio.numero}}</p>
                </div>
                <div class="callout callout-success">
                  <h5>Estado del servicio</h5>
                  <p>{{servicio.estado}}</p>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>

         <div class="col-sm-6 mt-3">
          <div id="map" style="height: 500px; width: 100%; border: 1px, solid; border-color: black;"></div>
         </div>
         {%else%}
         <div class="alert alert-success alert-dismissible col-md-6">
          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
          <h5><i class="icon fas fa-check"></i> No hay servicios en curso</h5>
          Que tengas buen regreso!
        </div>
        <div class="col-md-6">
          <div id="map" style="height: 500px; width: 100%; border: 1px, solid; border-color: black;"></div>
        </div>
         {%endif%}

        </div>
         <div id="details" class="mt-3"></div>

         <div class="row col-sm-12">

         </div>

    </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/0f48f5107a.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>

<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgZ9iDyLaJEwAAYUcuN7MgVWN2alaLd1s&libraries=places"></script>
<!-- <script>
let detalles = document.getElementById("details")
var options = {
    enableHighAccuracy: true,
    timeout: 5000,
    maximumAge: 0
  }

  var reqcount = 0
  navigator.geolocation.watchPosition(successCallback, errorCallback, options)

  function successCallback(position) {
    const {accuracy, latitude,  longitude, heading, speed } = position.coords
    reqcount++
    let speedKmh = speed !== null ? (speed * 3.6).toFixed(2) + "km/h" : "No disponible"
    console.log("Exactitud:", accuracy, 
                "Latitud:", latitude, 
                "Longitud:", longitude, 
                "Heading:", heading ?? "No disponible", 
                "Velocidad:", speedKmh);
   
    detalles.innerHTML = "Accuracy: " + accuracy + "</br>"
    detalles.innerHTML += "Latitude: " + latitude + " | Longitude: " + longitude + "</br>"
    detalles.innerHTML += "Heading: " + heading + "</br>"
    detalles.innerHTML += "Speed: " + speedKmh + "</br>"
    detalles.innerHTML += "reqcount: " + reqcount + "</br>"

  }
  function errorCallback(error){
    console.error("Error obteniendo la ubicación:", error);
  }



  navigator.geolocation.getCurrentPosition(position => {
    let { latitude, longitude } = position.coords;
    console.log("lat:", latitude, "long:", longitude);

    // Inicializar el mapa
    let map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: latitude, lng: longitude },
      zoom: 13
    });

    // Agregar marcador en la ubicación actual
    let marker = new google.maps.Marker({
      position: { lat: latitude, lng: longitude },
      map: map,
      title: "Ubicación actual"
    });
  }, error => {
    console.error("Error obteniendo la ubicación:", error);
  });
</script> -->

<script>

  var socket = new WebSocket(`wss://${window.location.host}/ws/location/`);

  socket.onopen = () => console.log("WebSocket conectado");
  socket.onerror = (error) => console.log("Error en WebSocket:", error);
  socket.onmessage = (event) => console.log("Mensaje recibido:", event.data);
  socket.onclose = () => console.log("WebSocket cerrado");


  let detalle = document.getElementById("details")
  // Cuando se conecta
  socket.onopen = function() {
      console.log("Conectado al WebSocket");
  };

  // Cuando recibe datos desde el servidor
  socket.onmessage = function(e) {
      var data = JSON.parse(e.data);
      var lat = data.latitude;
      var lng = data.longitude;
      var speed = data.speed;
      var heading = data.heading;

      detalle.innerHTML = "Latitud: " + lat + "</br>"
      detalle.innerHTML += "Longitud: " + lng + "</br>"
      detalle.innerHTML += "Velocidad: " + speed*3.6 + "km/h </br>"

      console.log("Nueva ubicación: ", lat, lng);
      console.log("Velocidad:", speed, "Heading:", heading);

      // Actualiza el mapa aquí con los nuevos datos

      updateMap(lat, lng);
  };

  // Enviar ubicación al servidor cada vez que cambie
  navigator.geolocation.watchPosition(function(position) {
      const { latitude, longitude, heading, speed } = position.coords;

      // Enviar al WebSocket
      socket.send(JSON.stringify({
          'latitude': latitude,
          'longitude': longitude,
          'speed': speed,
          'heading': heading,
      }));
  });

  let movil = document.getElementById('movil').innerText
  console.log('movil: ' , movil)

  function cargarServicios() {
    fetch("/servicio_movil/"+movil)
        .then(response => {
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            return response.json();
        })
        .then(data => {
          console.log('data: ', data)
            let servicios = data.servicios;
            let moviles = data.moviles;
            let tipomovil = data.tipomovil
            let tiposervicio = data.tiposervicio

            servicios.forEach(servicio => {
                let latitud = parseFloat(servicio.latitud);  // 🔍 Asegurar que sea número
                let longitud = parseFloat(servicio.longitud);

                if (isNaN(latitud) || isNaN(longitud)) {
                    console.error(`⚠️ Servicio con datos inválidos: `, servicio);
                    return; // 🔴 Si lat/lng no son números, no crea el marcador
                }

                let idServicio = `${servicio.direccion}-${latitud}-${longitud}`;

                if (!markers[idServicio]) {
                    let serviciotipo = tiposervicio.find(tipo => servicio.tipo === tipo.id)
                    console.log("tipo servicio: ", servicio)
                    let icono = servicio ? {
                        url: staticUrl +serviciotipo + ".png",
                        scaledSize: new google.maps.Size(35, 30),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(10, 10)
                    } : null;

                    let marker = new google.maps.Marker({
                        position: { lat: latitud, lng: longitud },
                        map: map,
                        icon: icono,
                        title: servicio ? serviciotipo : "Móvil Desconocido"
                    });

                    let infowindow = new google.maps.InfoWindow({
                        content: `<strong>${servicio.direccion}</strong><br><strong>${serviciotipo.tipo}</strong>`
                    });

                    marker.addListener("click", function () {
                        infowindow.open(map, marker);
                    });


                    markers[idServicio] = marker;
                }
            });

        })
        .catch(error => console.error("Error al obtener los servicios:", error));      
}

  function updateMap(lat, lng) {
      var map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: lat, lng: lng },
          zoom: 13
      });

      var marker = new google.maps.Marker({
          position: { lat: lat, lng: lng },
          map: map,
          title: "Ubicación actual"
      });
  }

  cargarServicios()

</script>
</body>

</html>