<!DOCTYPE html>
<html lang="en">
    <head>
        {% load static %}
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Intranet - Movil</title>
        <link rel="icon" href="{% static 'planilla/logo.png' %}" type="image/png" />       
        <!-- Google Font: Source Sans Pro -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/css/adminlte.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css">
    </head>

  <body>

    <div class="wrapper">
<style>
  #map {
      height: 500px;
      width: 100%;
  }
</style>
    <!-- Content Wrapper. Contains page content -->
    <div class="">
    <!-- Content Header (Page header) -->
    <div class="content-header bg-danger">
        <div class="container-fluid">
        <div class="col-sm-12 text-center">
          <h3><strong>PANEL DE COMANDO - MÓVIL {{movil.numero}}</strong></h3>
        </div><!-- /.col -->
        </div>
        <!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
        <div class="container-fluid">
          {% if servicio %}
          <span id="movil">{{movil.id}}</span>
        <!-- 1ra fila -->
         <div class="row">
          <div class="col-md-6 mt-2" style="max-height: 500px;">
            <div class="card card-danger">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-bullhorn"></i>
                  Intervención en curso
                </h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <div class="callout callout-danger">
                  <h5>Tipo de servicio</h5>
                  <p>{{ servicio.tipo.tipo }}</p>
                </div>
                <div class="callout callout-info">
                  <h5>Dirección</h5>
                  <p>{{servicio.direccion}}</p>
                  <button class="btn btn-secondary" onclick="iniciarNavegacion(-34.657713, -58.632396); monitorearUbicacion(-34.657713, -58.632396);">
                    Iniciar Navegación
                </button>
                </div>
                <div class="callout callout-warning">
                  <h5>Número de servicio</h5>
                  <p>{{servicio.numero}}</p>
                </div>
                <div class="callout callout-success">
                  <h5>Estado del servicio</h5>
                  <p>{{servicio.estado}}</p>
                </div>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>

         <div class="col-sm-6 mt-3">
          <div id="map" style="height: 500px; width: 100%; border: 1px, solid; border-color: black;"></div>
         </div>
         {%else%}
         <div class="alert alert-success alert-dismissible col-md-6">
          <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
          <h5><i class="icon fas fa-check"></i> No hay servicios en curso</h5>
          Que tengas buen regreso!
        </div>
        <div class="col-md-6">
          <div id="map" style="height: 500px; width: 100%; border: 1px, solid; border-color: black;"></div>
        </div>
         {%endif%}

        </div>
         <div id="details" class="mt-3"></div>

         <div class="row col-sm-12">

         </div>

    </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/0f48f5107a.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>

<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDgZ9iDyLaJEwAAYUcuN7MgVWN2alaLd1s&libraries=places,geometry&callback=initMap"></script>

<script>
  var staticUrl = "{% static '/planilla/images/' %}";

  var socket = new WebSocket(`wss://${window.location.host}/ws/location/`);
  console.log(socket)

  socket.onopen = () => console.log("WebSocket conectado");
  socket.onerror = (error) => console.log("Error en WebSocket:", error);
  socket.onmessage = (event) => console.log("Mensaje recibido:", event.data);
  socket.onclose = () => console.log("WebSocket cerrado");

  let detalle = document.getElementById("details")
  // Cuando se conecta
  socket.onopen = function() {
      console.log("Conectado al WebSocket");
  };

  // Cuando recibe datos desde el servidor
  socket.onmessage = function(e) {
      var data = JSON.parse(e.data);
      var lat = data.latitude;
      var lng = data.longitude;
      var speed = data.speed;
      var heading = data.heading;

      detalle.innerHTML = "Latitud: " + lat + "</br>"
      detalle.innerHTML += "Longitud: " + lng + "</br>"
      detalle.innerHTML += "Velocidad: " + speed*3.6 + "km/h </br>"

      console.log("Nueva ubicación: ", lat, lng);
      console.log("Velocidad:", speed, "Heading:", heading);

      // Actualiza el mapa aquí con los nuevos datos

      updateMap(lat, lng);
  };

var map;
var currentMarker; // Guardará el marcador de la posición actual
var markers = []

function initMap() {
    console.log(typeof initMap);
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -34.657713, lng: -58.632396 }, // Centro inicial
        zoom: 13
    });

    currentMarker = new google.maps.Marker({
        map: map,
        title: "Ubicación actual",
        icon: {
            url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png", // Icono personalizado para diferenciar ubicación
            scaledSize: new google.maps.Size(40, 40)
        }
    });

    cargarServicios(); // Cargar los servicios al iniciar
}

// WebSocket para actualizar la ubicación en tiempo real
navigator.geolocation.watchPosition(function(position) {
    const { latitude, longitude, heading, speed } = position.coords;
    updateMap(latitude, longitude);
    
    // Enviar ubicación al WebSocket
    socket.send(JSON.stringify({
        'latitude': latitude,
        'longitude': longitude,
        'speed': speed,
        'heading': heading,
    }));
});

function updateMap(lat, lng) {
    if (!map) return; // Evita errores si `map` no está inicializado
    map.setCenter(new google.maps.LatLng(lat, lng));
    currentMarker.setPosition(new google.maps.LatLng(lat, lng));
    cargarServicios()
}

let movil = document.getElementById('movil').textContent
console.log(movil)
function cargarServicios() {
    fetch("/servicio_movil/"+movil)
        .then(response => response.json())
        .then(data => {
            let servicios = data.servicios;
            let tiposervicio = data.tiposervicio;

            if (!Array.isArray(servicios)) {
                console.error("⚠️ Error: 'servicios' no es un array.");
                return;
            }

            servicios.forEach(servicio => {
                let latitud = parseFloat(servicio.latitud);
                let longitud = parseFloat(servicio.longitud);
                if (isNaN(latitud) || isNaN(longitud)) {
                    console.warn(`⚠️ Servicio con coordenadas inválidas:`, servicio);
                    return;
                }

                let idServicio = `${servicio.direccion}-${latitud}-${longitud}`;
                if (!markers[idServicio]) {
                    let serviciotipo = tiposervicio.find(t => t.id === servicio.tipo);
                    let icono = {
                        url: staticUrl + (serviciotipo ? serviciotipo.tipo : "default") + ".png",
                        scaledSize: new google.maps.Size(40, 40),
                        origin: new google.maps.Point(0, 0),
                        anchor: new google.maps.Point(10, 10)
                    };

                    let marker = new google.maps.Marker({
                        position: { lat: latitud, lng: longitud },
                        map: map,
                        icon: icono,
                        title: `${servicio.direccion}`
                    });

                    let infowindow = new google.maps.InfoWindow({
                        content: `<strong>${servicio.direccion}</strong><br><strong>${serviciotipo ? serviciotipo.tipo : "Desconocido"}</strong>`
                    });

                    marker.addListener("click", function () {
                        infowindow.open(map, marker);
                    });

                    markers[idServicio] = marker;
                }
            });

            // Dibujar una línea desde la posición actual al servicio
            // trazarRuta();
        })
        .catch(error => console.error("Error al obtener los servicios:", error));
}

// 🔹 Función para trazar una ruta desde la posición actual hasta el primer servicio disponible
function trazarRuta() {
    let servicioKeys = Object.keys(markers);
    if (servicioKeys.length === 0 || !currentMarker.getPosition()) return;

    let directionsService = new google.maps.DirectionsService();
    let directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
      map: map
     });

    let destino = markers[servicioKeys[0]].getPosition(); // Tomar el primer servicio

    let request = {
        origin: currentMarker.getPosition(),
        destination: destino,
        travelMode: google.maps.TravelMode.DRIVING
    };

    directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
        } else {
            console.error("Error al calcular ruta:", status);
        }
    });
}

function iniciarNavegacion(lat, lng) {
    // URL para abrir Google Maps en modo conducción
    let url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
    
    // Abrir en una nueva ventana o en la app de Google Maps
    window.location.href = url;
}

function monitorearUbicacion(destLat, destLng) {
    let threshold = 0.0005; // Margen de error (~50m)
    
    navigator.geolocation.watchPosition(position => {
        let { latitude, longitude } = position.coords;
        let distancia = getDistance(latitude, longitude, destLat, destLng);

        console.log(`Distancia al destino: ${distancia} metros`);

        if (distancia < 50) { // Si está a menos de 50 metros
            alert("🚗 Llegaste a tu destino.");
            // Aquí podrías hacer algo más, como mostrar un mensaje en tu app
        }
    });
}

// Función para calcular la distancia en metros entre dos coordenadas
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000; // Radio de la Tierra en metros
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    
    return R * c; // Distancia en metros
}


</script>
</body>

</html>